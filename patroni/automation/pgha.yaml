# Percona Distribution for PostgreSQL: High Availability with Streaming Replication
#   - (Percona Distribution for PostgreSQL-based deployment)
# @author: Charly Batista <charly.batista@percona.com>
# @date: 2023-10-09
# 

#
# pgha.yam
# Configuration file for the pgha_install tool
# 

---
pgha:
  postgres:
    # 
    listen_addr: 0.0.0.0
    listen_port: 5432

    # 
    max_connections: 100

    #
    shared_buffers: 512MB
    effective_cache_size: 
    work_mem: 8MB
    maintenance_work_mem: 64MB
    wal_buffers: 16MB

    #
    checkpoint_timeout: 30
    checkpoint_completion_target: 0.9

    #
    hot_standby: "on"
    max_wal_senders: 5
    max_replication_slots: 10

    #
    synchronous_commit: "on"

    # 
    wal_level: logical
    wal_compression: "on"
    min_wal_size: 80M
    max_wal_size: 1GB
    wal_keep_size: 4096
    wal_log_hints: "on"

    #
    default_statistics_target: 100
    random_page_cost: 1.1
    effective_io_concurrency: 200

    #
    max_worker_processes: 4
    max_parallel_workers_per_gather: 2
    max_parallel_workers: 4
    max_parallel_maintenance_workers: 2

    # 
    archive_mode: "on"
    archive_library: ""
    archive_command: 'pgbackrest --config={{ config_dir }}/pgbackrest.conf --stanza={{ pg_cluster_name }} archive-push "{{ pg_data_dir }}/pg_wal/%f"'
    archive_timeout: 1800
    restore_command: 'pgbackrest --config={{ config_dir }}/pgbackrest.conf --stanza={{ pg_cluster_name }} archive-get %f "%p"'
    
    # 
    logging_collector: 'on'
  
  # Patroni variables
  patroni:
    namespace: pg_ha
    scope: "{{ pg_cluster_name }}"

    #
    rest_api_listen: 0.0.0.0

    #
    dcs_ttl: 30
    dcs_loop_wait: 10
    dcs_retry_timeout: 10
    dcs_max_lag_failover: 1048576
    dcs_slot_name: percona_{{ pg_cluster_name }}
    dcs_slot_type: physical
    use_pg_rewind: "true"
    use_slots: "true"
    backrest_restore_bkp: "/usr/bin/pgbackrest --stanza={{ pg_cluster_name }} --delta restore"
    backrest_keep_data: "true"
    backrest_no_params: "true"

    # 
    pass_file: "{{ config_dir }}/.pgpass"
    repl_username: replicator
    repl_password: R3pl1c4t0r
    super_username: postgres
    super_password: PostP4ss
    admin_username: admin
    admin_password: Pgadm1n